INFO:__main__:============================================================
INFO:__main__:SPARK STREAMING CONSUMER - VIETNAM STOCK MARKET
INFO:__main__:============================================================
:: loading settings :: url = jar:file:/usr/local/spark-3.3.0-bin-hadoop3/jars/ivy-2.5.0.jar!/org/apache/ivy/core/settings/ivysettings.xml
Ivy Default Cache set to: /home/jovyan/.ivy2/cache
The jars for the packages stored in: /home/jovyan/.ivy2/jars
org.apache.spark#spark-sql-kafka-0-10_2.12 added as a dependency
:: resolving dependencies :: org.apache.spark#spark-submit-parent-b64e7566-86c2-4072-8c65-ccf6f6d42207;1.0
	confs: [default]
	found org.apache.spark#spark-sql-kafka-0-10_2.12;3.3.0 in central
	found org.apache.spark#spark-token-provider-kafka-0-10_2.12;3.3.0 in central
	found org.apache.kafka#kafka-clients;2.8.1 in central
	found org.lz4#lz4-java;1.8.0 in central
	found org.xerial.snappy#snappy-java;1.1.8.4 in central
	found org.slf4j#slf4j-api;1.7.32 in central
	found org.apache.hadoop#hadoop-client-runtime;3.3.2 in central
	found org.spark-project.spark#unused;1.0.0 in central
	found org.apache.hadoop#hadoop-client-api;3.3.2 in central
	found commons-logging#commons-logging;1.1.3 in central
	found com.google.code.findbugs#jsr305;3.0.0 in central
	found org.apache.commons#commons-pool2;2.11.1 in central
:: resolution report :: resolve 520ms :: artifacts dl 14ms
	:: modules in use:
	com.google.code.findbugs#jsr305;3.0.0 from central in [default]
	commons-logging#commons-logging;1.1.3 from central in [default]
	org.apache.commons#commons-pool2;2.11.1 from central in [default]
	org.apache.hadoop#hadoop-client-api;3.3.2 from central in [default]
	org.apache.hadoop#hadoop-client-runtime;3.3.2 from central in [default]
	org.apache.kafka#kafka-clients;2.8.1 from central in [default]
	org.apache.spark#spark-sql-kafka-0-10_2.12;3.3.0 from central in [default]
	org.apache.spark#spark-token-provider-kafka-0-10_2.12;3.3.0 from central in [default]
	org.lz4#lz4-java;1.8.0 from central in [default]
	org.slf4j#slf4j-api;1.7.32 from central in [default]
	org.spark-project.spark#unused;1.0.0 from central in [default]
	org.xerial.snappy#snappy-java;1.1.8.4 from central in [default]
	---------------------------------------------------------------------
	|                  |            modules            ||   artifacts   |
	|       conf       | number| search|dwnlded|evicted|| number|dwnlded|
	---------------------------------------------------------------------
	|      default     |   12  |   0   |   0   |   0   ||   12  |   0   |
	---------------------------------------------------------------------
:: retrieving :: org.apache.spark#spark-submit-parent-b64e7566-86c2-4072-8c65-ccf6f6d42207
	confs: [default]
	0 artifacts copied, 12 already retrieved (0kB/8ms)
25/11/15 14:03:43 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Setting default log level to "WARN".
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
25/11/15 14:03:44 WARN Utils: Service 'SparkUI' could not bind on port 4040. Attempting port 4041.
INFO:__main__:Spark Session created successfully
INFO:__main__:Connected to Kafka topic: vietnam_stocks
25/11/15 14:03:50 WARN package: Truncated the string representation of a plan since it was too large. This behavior can be adjusted by setting 'spark.sql.debug.maxToStringFields'.
INFO:py4j.java_gateway:Callback Server Starting
INFO:py4j.java_gateway:Socket listening on ('127.0.0.1', 40947)
25/11/15 14:03:54 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.
INFO:__main__:Redis output stream started
25/11/15 14:03:55 WARN ResolveWriteToStream: spark.sql.adaptive.enabled is not supported in streaming DataFrames/Datasets and will be disabled.
INFO:__main__:Console output stream started
Traceback (most recent call last):
  File "/home/jovyan/work/market_risk/spark_consumer.py", line 436, in <module>
    main()
  File "/home/jovyan/work/market_risk/spark_consumer.py", line 310, in main
    .withWatermark("timestamp", "1 minute") \
  File "/opt/conda/lib/python3.10/site-packages/pyspark/sql/dataframe.py", line 746, in withWatermark
    jdf = self._jdf.withWatermark(eventTime, delayThreshold)
  File "/opt/conda/lib/python3.10/site-packages/py4j/java_gateway.py", line 1321, in __call__
    return_value = get_return_value(
  File "/opt/conda/lib/python3.10/site-packages/pyspark/sql/utils.py", line 196, in deco
    raise converted from None
pyspark.sql.utils.AnalysisException: Event time must be defined on a window or a timestamp, but timestamp is of type string;
EventTimeWatermark timestamp#25: string, 1 minutes
+- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 25 more fields]
   +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 24 more fields]
      +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 23 more fields]
         +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 22 more fields]
            +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 21 more fields]
               +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 20 more fields]
                  +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 19 more fields]
                     +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 18 more fields]
                        +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 17 more fields]
                           +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 16 more fields]
                              +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 15 more fields]
                                 +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 14 more fields]
                                    +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 13 more fields]
                                       +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 12 more fields]
                                          +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 11 more fields]
                                             +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 10 more fields]
                                                +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 9 more fields]
                                                   +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 8 more fields]
                                                      +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 7 more fields]
                                                         +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 6 more fields]
                                                            +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 5 more fields]
                                                               +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 4 more fields]
                                                                  +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 3 more fields]
                                                                     +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, ... 2 more fields]
                                                                        +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, foreign_net#140L, (ask_price#49 - bid_price#47) AS spread#165]
                                                                           +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, price_change_percent#116, (foreign_buy#43L - foreign_sell#44L) AS foreign_net#140L]
                                                                              +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, price_change#93, (((price#33 - ref_price#37) / ref_price#37) * cast(100 as double)) AS price_change_percent#116]
                                                                                 +- Project [symbol#32, timestamp#25, price#33, volume#34L, total_volume#35L, total_value#36, ref_price#37, prior_close#38, ceiling#39, floor#40, high#41, low#42, foreign_buy#43L, foreign_sell#44L, current_room#45L, total_room#46L, bid_price#47, bid_volume#48L, ask_price#49, ask_volume#50L, company_name#51, (price#33 - ref_price#37) AS price_change#93]
                                                                                    +- Project [data#26.symbol AS symbol#32, timestamp#25, data#26.match_price AS price#33, data#26.match_vol AS volume#34L, data#26.accumulated_volume AS total_volume#35L, data#26.accumulated_value AS total_value#36, data#26.ref_price AS ref_price#37, data#26.prior_close_price AS prior_close#38, data#26.ceiling AS ceiling#39, data#26.floor AS floor#40, data#26.highest AS high#41, data#26.lowest AS low#42, data#26.foreign_buy_volume AS foreign_buy#43L, data#26.foreign_sell_volume AS foreign_sell#44L, data#26.current_room AS current_room#45L, data#26.total_room AS total_room#46L, data#26.bid_1_price AS bid_price#47, data#26.bid_1_volume AS bid_volume#48L, data#26.ask_1_price AS ask_price#49, data#26.ask_1_volume AS ask_volume#50L, data#26.organ_name AS company_name#51]
                                                                                       +- Project [symbol_key#21, json_data#22.timestamp AS timestamp#25, json_data#22.data AS data#26]
                                                                                          +- Project [cast(key#7 as string) AS symbol_key#21, from_json(StructField(timestamp,StringType,true), StructField(data,StructType(StructField(symbol,StringType,true),StructField(ceiling,DoubleType,true),StructField(floor,DoubleType,true),StructField(ref_price,DoubleType,true),StructField(stock_type,StringType,true),StructField(exchange,StringType,true),StructField(last_trading_date,StringType,true),StructField(listed_share,LongType,true),StructField(type,StringType,true),StructField(id,LongType,true),StructField(organ_name,StringType,true),StructField(prior_close_price,DoubleType,true),StructField(match_price,DoubleType,true),StructField(match_vol,LongType,true),StructField(accumulated_volume,LongType,true),StructField(accumulated_value,DoubleType,true),StructField(avg_match_price,DoubleType,true),StructField(highest,DoubleType,true),StructField(lowest,DoubleType,true),StructField(match_type,StringType,true),StructField(foreign_sell_volume,LongType,true),StructField(foreign_buy_volume,LongType,true),StructField(current_room,LongType,true),StructField(total_room,LongType,true),StructField(bid_1_price,DoubleType,true),StructField(bid_1_volume,LongType,true),StructField(bid_2_price,DoubleType,true),StructField(bid_2_volume,LongType,true),StructField(bid_3_price,DoubleType,true),StructField(bid_3_volume,LongType,true),StructField(ask_1_price,DoubleType,true),StructField(ask_1_volume,LongType,true),StructField(ask_2_price,DoubleType,true),StructField(ask_2_volume,LongType,true),StructField(ask_3_price,DoubleType,true),StructField(ask_3_volume,LongType,true)),true), cast(value#8 as string), Some(Etc/UTC)) AS json_data#22]
                                                                                             +- StreamingRelationV2 org.apache.spark.sql.kafka010.KafkaSourceProvider@3f7dd62f, kafka, org.apache.spark.sql.kafka010.KafkaSourceProvider$KafkaTable@765b73b7, [startingOffsets=latest, kafka.bootstrap.servers=kafka:9092, subscribe=vietnam_stocks], [key#7, value#8, topic#9, partition#10, offset#11L, timestamp#12, timestampType#13], StreamingRelation DataSource(org.apache.spark.sql.SparkSession@633ca7cc,kafka,List(),None,List(),None,Map(kafka.bootstrap.servers -> kafka:9092, subscribe -> vietnam_stocks, startingOffsets -> latest),None), kafka, [key#0, value#1, topic#2, partition#3, offset#4L, timestamp#5, timestampType#6]

INFO:py4j.clientserver:Closing down clientserver connection
